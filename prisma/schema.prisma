// 개발 초기, 주석사용
// 중급 프로젝트 전, 주석 제거예정
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN	// 슈퍼 관리자
  ADMIN			  // 관리자
  RESIDENT		// 입주민
}

enum JoinStatus {
  PENDING	  // 대기
  APPROVED	// 승인
  REJECTED	// 거절
}

model User {
  id           String     @id				@default(cuid())
  username     String     @unique			    // 유저 아이디
  password     String
  email        String     @unique
  contact      String	    @unique
  name         String
  role         UserRole   @default(RESIDENT)
  avatar       String?						        // 프로필 이미지
  joinStatus   JoinStatus @default(PENDING)
  isActive     Boolean    @default(false)	// 로그인 여부로 추정
  refreshToken String?
  createdAt    DateTime	  @default(now())
  updatedAt    DateTime   @updatedAt
  version	     Int		    @default(1)

  // 1:1 관계
  adminOf    Apartment?   @relation("ApartmentManager")
  resident   Resident?    @relation("ResidentProfile")

  // 1:n 관계
  notices    Notice[]						          // 공지사항
  complaints Complaint[]					        // 민원
  polls      Poll[]							          // 투표
  pollVotes  PollVote[]						        // 투표용
  comments   Comment[]						        // 댓글
  residentImportLogs ResidentImportLog[]  // 입주민 일괄등록 로그

  notifications Notification[]			      // 알림
}

model Apartment {
  id            String   @id @default(cuid())
  name          String
  address       String
  description   String?
  officeNumber  String?
  managerId     String?  @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  version       Int      @default(1)

  // User 삭제 => Apartment 삭제 X (관리자 삭제되어도 아파트는 유지)
  manager User? @relation("ApartmentManager", fields: [managerId], references: [id], onDelete: SetNull)

  // 1:n 관계
  buildings          Building[]
  units              Unit[]
  residents          Resident[]
  complaints         Complaint[]
  polls              Poll[]
  notices            Notice[]
  events             Event[]
  residentImportLogs ResidentImportLog[]

  @@index([managerId])
}

model Building {
  id          String   @id @default(cuid())
  buildingNo  String   // 동 번호 (예: "101동", "A동")
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Apartment 삭제 => Building 삭제 O
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // 1:n 관계
  units Unit[]

  @@unique([apartmentId, buildingNo])
  @@index([apartmentId])
}

model Unit {
  id        String   @id @default(cuid())
  unitNo    String   // 호수 (예: "101호", "201호")
  floor     Int?     // 층
  area      Float?   // 전용면적
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Apartment 삭제 => Unit 삭제 O
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // Building 삭제 => Unit 삭제 O
  buildingId String
  building   Building @relation(fields: [buildingId], references: [id], onDelete: Cascade)

  @@unique([apartmentId, buildingId, unitNo])
  @@index([apartmentId])
  @@index([buildingId])
}

model Resident {
  id            String   @id @default(cuid())
  email         String?
  contact       String?
  name          String
  building      Int
  unit          Int
  isHouseholder Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  version       Int      @default(1)

  userId String @unique
  user   User   @relation("ResidentProfile", fields: [userId], references: [id], onDelete: Cascade)

  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  @@index([apartmentId])
  @@index([userId])
  @@index([apartmentId, isHouseholder])
}
// 엑셀/csv파일로 여러 입주민 데이터를 한번에 등록하기 위한 모델
model ResidentImportLog {
  id           String   @id
  fileName     String
  totalCount   Int
  successCount Int
  failCount    Int
  status       String   @default("pending") // pending, success, failed
  errorMessage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apartmentId])
  @@index([userId])
}

enum ComplaintStatus {
  PENDING         // 접수
  IN_PROGRESS     // 처리중
  RESOLVED       // 처리 완료
}

enum PollStatus {
  PENDING         // 투표 전
  IN_PROGRESS     // 투표 진행 중
  CLOSED          // 투표 종료
}

model Complaint {
  id        String   @id		  @default(cuid())
  title     String
  content   String

  status    ComplaintStatus   @default(PENDING)  // enum 적용
  isPublic  Boolean  @default(true)       // 공개, 비공개 민원
  viewsCount Int     @default(0)          // 조회수

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // 댓글 수 계산용 (Comment 재사용 or 전용 테이블 가능)
  comments Comment[]

  // 1:n 관계
  notifications Notification[]

  @@index([userId])
  @@index([apartmentId])
  @@index([status])
}

model Poll {
  id        String    @id		  @default(cuid())
  title     String
  content   String
  status    PollStatus  @default(PENDING) // enum 적용
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  endDate   DateTime?
  version   Int       @default(1)

  // User 삭제 => Poll 삭제 O (투표 작성자)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Apartment 삭제 => Poll 삭제 O
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // 1:n
  options       PollOption[]
  votes         PollVote[]
  notifications Notification[]

  @@index([userId])
  @@index([apartmentId])
  @@index([status])
}

model PollOption {
  id        String  @id		  @default(cuid())
  text      String
  order     Int
  voteCount Int     @default(0)

  // Poll 삭제 => PollOption 삭제 O
  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  // 1:n
  votes PollVote[]

  @@unique([pollId, order])
  @@index([pollId])
}

model PollVote {
  createdAt DateTime @default(now())

  // User 삭제 => PollVote 삭제 O
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Poll 삭제 => PollVote 삭제 O
  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  // PollOption 삭제 => PollVote 삭제 O
  optionId String
  option   PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([userId, pollId])
  @@index([userId])
  @@index([pollId])
  @@index([optionId])
}

enum NoticeCategory {
  REGULAR_CHECK   // 정기검진
  EMERGENCY       // 긴급사항
  COMMUNITY       // 커뮤니티
  VOTE            // 주민투표
  COMPLAINT       // 민원
  ETC             // 기타
}

enum NoticeType {
  NORMAL
  IMPORTANT
}

enum EventResourceType {
  NOTICE
  POLL
}

model Notice {
  id        String   @id @default(cuid())
  title     String
  content   String
  category  NoticeCategory
  type      NoticeType @default(NORMAL)

  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // 관계
  comments       Comment[]
  notifications  Notification[]
  event          Event?        // 1:1 (공지 일정)

  @@index([apartmentId])
  @@index([category])
}

model Event {
  id        String @id @default(cuid())
  title     String

  startDate DateTime
  endDate   DateTime

  // 공지와 1:1 관계
  noticeId String  @unique
  notice   Notice  @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  resourceType EventResourceType @default(NOTICE)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  @@index([apartmentId, startDate])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 공지 댓글
  noticeId String?
  notice   Notice? @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  // 댓글 수 계산용
  complaintId String?
  complaint   Complaint? @relation(fields: [complaintId], references: [id], onDelete: Cascade)

  notifications Notification[]

  @@index([noticeId])
}

model Notification {
  id        String   @id @default(cuid())
  content   String   // 알림 내용
  isChecked Boolean  @default(false) // 확인 여부
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // User 삭제 => Notification 삭제 O (수신자)
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  complaintId String?
  complaint   Complaint? @relation(fields: [complaintId], references: [id], onDelete: Cascade)
  pollId      String?
  poll        Poll?      @relation(fields: [pollId], references: [id], onDelete: Cascade)
  noticeId    String?
  notice      Notice?    @relation(fields: [noticeId], references: [id], onDelete: Cascade)
  commentId   String?
  comment     Comment?   @relation(fields: [commentId], references: [id], onDelete: Cascade)

  // 인덱스 최적화
  @@index([userId])
  @@index([userId, isChecked])
  @@index([createdAt])
  @@index([isChecked])
  // 각 타입별 최적화
  @@index([complaintId])
  @@index([pollId])
  @@index([noticeId])
  @@index([commentId])
}