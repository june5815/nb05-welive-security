// 개발 초기, 주석사용
// 중간 발표 전, 주석 제거예정
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  SUPER_ADMIN	// 슈퍼 관리자
  ADMIN			  // 관리자
  USER		    // 입주민
}

enum JoinStatus {
  PENDING     // 대기
  APPROVED    // 승인
  REJECTED    // 거절
}

enum UserType {
  PRE_RESIDENT //가등록 (관리자가 CSV파일로 일괄 등록했을 경우)
  RESIDENT //등록 (관리자 등록 후, 입주민이 개별 회원가입한 경우)
}

model User {
  id           String     @id @default(uuid())
  username     String     @unique
  password     String
  email        String     @unique
  contact      String     @unique
  name         String
  role         UserRole
  avatar       String? // 프로필 이미지
  joinStatus   JoinStatus @default(PENDING)
  isActive     Boolean    @default(false) // 계정 활성화 여부
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  version      Int        @default(1)

  // 1:1 관계
  adminOf Apartment? @relation("ApartmentManager")

  resident           HouseholdMember[] // 세대원
  notices            Notice[] // 공지사항
  complaints         Complaint[] // 민원
  polls              Poll[] // 투표
  pollVotes          PollVote[] // 투표용
  comments           Comment[] // 댓글
  residentImportLogs ResidentImportLog[] // 입주민 일괄등록 로그

  notificationReceipts NotificationReceipt[]  // 알림 수신
}

model RefreshToken{
  id            String    @id @default(uuid())
  refreshToken  String    @unique
  userId        String    @unique
  updatedAt     DateTime  @updatedAt

  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Apartment {
  id                    String  @id @default(uuid())
  name                  String
  address               String
  description           String
  officeNumber          String
  adminId               String? @unique
  buildingNumberFrom    Int
  buildingNumberTo      Int
  floorCountPerBuilding Int
  unitCountPerFloor     Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 1:1 관계
  admin User? @relation("ApartmentManager", fields: [adminId], references: [id])

  // 1:n 관계
  household          Household[]
  complaints         Complaint[]
  polls              Poll[]
  notices            Notice[]
  events             Event[]
  residentImportLogs ResidentImportLog[]

  @@unique([name, address, officeNumber])
  @@index([adminId])
}

//세대

enum HouseholdStatus {
  EMPTY // 공실  
  ACTIVE // 거주중인 상태
  MOVE_OUT // 이사한 상태
}

model Household {
  id              String          @id @default(uuid())
  apartmentId     String
  building        Int
  unit            Int
  householdStatus HouseholdStatus @default(EMPTY)

  apartment Apartment         @relation(fields: [apartmentId], references: [id], onDelete: Cascade)
  members   HouseholdMember[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  @@unique([apartmentId, building, unit])
  @@index([apartmentId])
}

//세대원
model HouseholdMember {
  id            String    @id @default(uuid())
  householdId   String
  userId        String
  isHouseholder Boolean   @default(false)
  movedInAt     DateTime? //전입 날짜
  movedOutAt    DateTime? //전출 날짜

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  household Household @relation(fields: [householdId], references: [id])
  user      User      @relation(fields: [userId], references: [id])

  @@unique([householdId, userId])
  @@index([userId])
}

// 엑셀/csv파일로 여러 입주민 데이터를 한번에 등록하기 위한 모델
model ResidentImportLog {
  id           String   @id
  fileName     String
  totalCount   Int
  successCount Int
  failCount    Int
  status       String   @default("pending") // pending, success, failed
  errorMessage String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([apartmentId])
  @@index([userId])
}

enum ComplaintStatus {
  PENDING // 접수
  IN_PROGRESS // 처리중
  RESOLVED // 처리 완료
}

model Complaint {
  id      String @id @default(uuid())
  title   String
  content String

  status     ComplaintStatus @default(PENDING) // enum 적용
  isPublic   Boolean         @default(true) // 공개, 비공개 민원
  viewsCount Int             @default(0) // 조회수

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([apartmentId])
  @@index([status])
}

enum PollStatus {
  PENDING // 투표 전
  IN_PROGRESS // 투표 진행 중
  CLOSED // 투표 종료
}

model Poll {
  id        String     @id @default(uuid())
  title     String
  content   String
  status    PollStatus @default(PENDING) // enum 적용
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  endDate   DateTime?
  version   Int        @default(1)

  // User 삭제 => Poll 삭제 O (투표 작성자)
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Apartment 삭제 => Poll 삭제 O
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  // 1:n
  options PollOption[]
  votes   PollVote[]

  @@index([userId])
  @@index([apartmentId])
  @@index([status])
}

model PollOption {
  id        String @id @default(uuid())
  text      String
  order     Int
  voteCount Int    @default(0)

  // Poll 삭제 => PollOption 삭제 O
  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  // 1:n
  votes PollVote[]

  @@unique([pollId, order])
  @@index([pollId])
}

model PollVote {
  createdAt DateTime @default(now())

  // User 삭제 => PollVote 삭제 O
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Poll 삭제 => PollVote 삭제 O
  pollId String
  poll   Poll   @relation(fields: [pollId], references: [id], onDelete: Cascade)

  // PollOption 삭제 => PollVote 삭제 O
  optionId String
  option   PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([userId, pollId])
  @@index([userId])
  @@index([pollId])
  @@index([optionId])
}

enum NoticeCategory {
  MAINTENANCE // 정기검진
  EMERGENCY // 긴급사항
  COMMUNITY // 커뮤니티
  RESIDENT_VOTE // 주민투표
  RESIDENT_COUNCIL // 민원
  ETC // 기타
}

enum NoticeType {
  NORMAL
  IMPORTANT
}

model Notice {
  id       String         @id @default(uuid())
  title    String
  content  String
  category NoticeCategory
  type     NoticeType     @default(NORMAL)

  viewCount Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  event Event? // 1:1 (공지 일정)

  @@index([apartmentId])
  @@index([category])
}

enum NotificationType {
  COMPLAINT_CREATED
  COMPLAINT_UPDATED
  POLL_CREATED
  POLL_ENDED
  NOTICE_POSTED
  COMMENT_ADDED
}

enum NotificationTargetType {
  COMPLAINT
  POLL
  NOTICE
  COMMENT
}

model NotificationEvent {
  id         String                 @id @default(uuid())
  type       NotificationType
  createdAt  DateTime               @default(now())
  version    Int                    @default(1)
  targetType NotificationTargetType
  targetId   String
  receipts   NotificationReceipt[]

  @@index([type, createdAt])
  @@index([targetType, targetId])
  @@index([createdAt])
}

model NotificationReceipt {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  eventId String
  event   NotificationEvent @relation(fields: [eventId], references: [id], onDelete: Cascade)

  isChecked Boolean   @default(false)
  checkedAt DateTime?
  isHidden  Boolean   @default(false)
  hiddenAt  DateTime?

  @@unique([userId, eventId])
  @@index([userId, isHidden, isChecked, createdAt])
  @@index([userId, createdAt])
}

enum EventResourceType {
  NOTICE
  POLL
}

model Event {
  id    String @id @default(uuid())
  title String

  startDate DateTime
  endDate   DateTime

  // 공지와 1:1 관계
  noticeId String @unique
  notice   Notice @relation(fields: [noticeId], references: [id], onDelete: Cascade)

  resourceType EventResourceType @default(NOTICE)

  // 아파트
  apartmentId String
  apartment   Apartment @relation(fields: [apartmentId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  @@index([apartmentId, startDate])
}

enum CommentResourceType {
  NOTICE
  COMPLAINT
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  version   Int      @default(1)

  // 작성자
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // 리소스 추상화
  resourceId   String
  resourceType CommentResourceType

  @@index([userId])
  @@index([resourceType, resourceId])
}
